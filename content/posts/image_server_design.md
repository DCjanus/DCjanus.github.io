---
title: "图片服务设计"
date: 2021-12-11T23:42:56+08:00
draft: true
authors: ['DCjanus']
tags: ['业务设计']
---

常见公有云的 OSS 都会提供与之配套的在线图片处理，通过修改 URL 或其他方法，可以轻松获得包括缩略、裁剪、格式转换、图文水印在内的多种功能，也有一些主打图片 CDN 的服务商提供类似功能。对于自建图片服务的企业来说，由于对消费端有更大的控制能力，可以应用更优化的技术方案。

尝试稍微总结设计这类业务需要注意的点，也可以让更多人了解，为了将司空见惯的图片展示在你面前，工程师们做了哪些努力。

<!--more-->

# 背景

对于大部分互联网应用，图片是重要的内容表示形式。相比文本，体积相对较大，是很多企业 CDN 带宽成本的重要组成部分；相对视频，展示延迟要求也更高，如果图片需要若干秒才能完整展示，那网站可能丢失 70% 以上的用户 ~~，除非你是 t66y 这样有足够独特性的平台~~ 。

图片服务最常用的功能就是缩略、裁剪和格式转换，可以降低 CDN 带宽成本，提升客户端展示速度。

但现实生活中，业务需求只会不断堆积，进而会接入诸如鉴黄、高斯模糊、获取图像主体色、图像特定区域加阴影等稀奇古怪的功能，在此按下不表。

# 设计

## 1. 在线/离线

相比简单的 CRUD 接口，图片处理是一个相对较慢的过程，设计为一个离线服务往往是较为直接的思路。但事实上由于现实情况的限制，绝大多数网站的图片处理都不会是一个离线服务，以新浪微博为例：

我在发微博页面尝试上传了一张 3840x2160 的图片，F12 抓包可以看到返回了一个 ID，随后网页 JS 将这个 ID 拼接到 URL 中，请求获取到了一张相对较小的 JPEG，其尺寸为 400x248，表现为在微博发送页面，展示了我刚刚上传图片的缩略图。

也就是说，大量场景下，要求用户上传后相对较快的可以看到图片转换后的结果，一般来说及时性要求是百毫秒级。另一方面，离线图像处理要求服务提供者有能力感知某个图片上传后所有可能的展示形式，提前为之生成对应图像并存储一定时间。对于大型企业来说，这往往是难以承受的。

但设计为在线处理，服务要保证绝大多数请求能够在可接受时间内完成，图像格式繁多，UGC 内容千奇百怪，绝大部分企业没有能力自研适配如此广泛的图片处理基础库；使用 ImageMgaick、libvips 之类的库，又因为缺乏调度点，CPU 密集的图像处理逻辑陷入后，应用层难以细粒度调度，特殊图片、超级大图处理耗时数分钟的情况并不罕见，需要避免少量重型任务影响总体服务质量。

## 2. 分隔符/请求参数

图片处理服务的调用，主要是为了传递“选择某张图”和“应用在其上的处理操作”两部分信息，一般通过 URL 的修改实现类似功能，但不同的调用形式之间也存在一些细微的区别。常见公有云图片处理服务主要是分隔符和请求参数两类形式，少数公开服务使用多级路径。

以阿里云旧版图片处理服务为例，其设计上使用 `@` 分隔图片地址和处理参数，如:

{{< image src="https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg@300w_300h.webp" caption="https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg@300w_300h.webp" width=300 >}}

其中 `@` 符号前的是[原始图片地址](https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg)，其后`300w_300h.webp`为缩略图参数，表示将原图等比例缩放为一个宽不大于300、高不大于300的 webp 图片。

阿里云新版图片处理服务则使用请求参数的形式，如与上面缩略图参数等价的请求：

{{< image src="https://image-demo.oss-cn-hangzhou.aliyuncs.com/example.jpg?x-oss-process=image/resize,w_300/format,webp" caption="https://image-demo.oss-cn-hangzhou.aliyuncs.com/example.jpg?x-oss-process=image/resize,w_300/format,webp" width=300 >}}

这里的缩略参数是`image/resize,w_300/format,webp`。

选择使用请求参数，要注意 CDN 和 内部缓存集群的缓存 Key 配置，要将特定的 Query Parameter Key 作为缓存 Key 的一部分。

选择使用 `@` 符号分隔，意味着原始文件名中的 `@` 符号可能造成一些非预期现象，如 `a.jpg@2x`、`a.jpg@3x` 是常见的设计资源命名形式，对于使用 `@` 符号分隔的服务，则有可能被认为尝试传递一个错误的图片处理参数。

这类场景往往将普通文件访问域名和图片处理域名区分开，如访问 `example.com/a.jpg@100w` 表示访问存储系统中名为 `a.jpg@100w` 的文件，访问`image.example.com/a.jpg@100w` 则表示请求 `example.com/a.jpg` 并进行处理。

由于内部实现细节的影响，部分 CDN 厂商只提供基于 `/` 分隔的前缀删除，这意味着你无法简单清理 `example.com/a.jpg@100w` 和 `example.com/a.jpg@200w` 的缓存。部分 CDN 厂商可能提供基于阉割版正则的批量清理逻辑，可以覆盖这类场景。

## 3. 自由组合/可配置模板

在统一图片服务的设计初期，工程师们往往着眼于如何让图片处理更加灵活，更加简单，减少图片服务团队和业务团队之间沟通所需的人力成本，提供大量图片处理参数，可以拼接组合满足大量业务场景需求。

但随着业务的不断演进，需求越来越复杂，演化过程中的 BUG，因为图片服务视角缺乏业务场景信息，任何外在表现的改动都有可能导致特定业务场景受损，需要无限期兼容历史 BUG。

仍然以阿里云图片服务为例，其提供了一种名为[图片样式](https://help.aliyun.com/document_detail/48884.html)的功能，即将一些特定的处理逻辑附加在一个特定的名字上，调用方在 URL 中使用这个名字，就意味着调用这个名字所对应的处理逻辑，而不需要拼接各种参数。

对于自建图片服务的企业来说，一般要求不同业务场景使用不同样式名，即使图片处理需求相同，也应该使用独立的名字，图片服务团队可以借此感知业务场景，降低管控成本。但这会导致不同场景的相同图片处理请求无法共享缓存。

除此之外，由于不同分辨率的设备上往往需要请求不同尺寸的图片，这意味着“选择图片处理参数”的逻辑往往写死在客户端，对于移动 APP 来说，出现线上问题、选择错图片处理参数时，修复问题只能通过发布新版本实现，会让问题修复周期无比漫长。如果客户端请求的是模板名，而不是直接使用缩略参数，则可以由服务端进行兼容，大大缩短问题修复时间。

## 4. 业务与处理逻辑分离

每个服务设计者都希望自己的用户是 Pwoer User：主动阅读文档、快速理解设计、能够将需求翻译为容易理解的语言，但现实生活中，来咨询你的程序员可能是三个月前刚从培训班毕业、指着他们组里自行维护的闭源框架代码问你为什么不能工作；即使现实情况没有这么糟糕，但大部分时候，编写代码的前端工程师、客户端工程师，往往也不希望在这样一个对他们来说“毫不起眼”的功能上研究太久，如果你的文档过于晦涩难懂，如果你的背景介绍太过冗长，一定会让人恼怒的。

这意味着，我们需要对外暴露尽可能接近业务感知的功能：如果宽大于高，先裁剪出来头部三分之一的区域，裁剪出来的图像放大到短边长度为 100px，随后中心裁剪出 100x100 的区域，再缩放为 50x50。对内转换为更实际的处理逻辑：裁剪 (a, b) 到 (c, d) 区域，缩放为 50x50。而不是混淆业务抽象和实际处理逻辑，真的按照业务描述执行多次图像处理操作。

## 5. ImageMgaick 的一些坑

TODO