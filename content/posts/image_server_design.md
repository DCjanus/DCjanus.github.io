---
title: "统一图片服务设计"
date: 2021-12-11T23:42:56+08:00
draft: true
author: DCjanus
description: "描述了统一图片服务的一些设计因素"
---

常见公有云都提供 OSS 和与之配套的在线图片处理服务，只要在 URL 上做一些小的修改，就可以获得多种图片处理功能，如尺寸缩略、格式转换、高斯模糊、内容裁剪等功能。但当尝试自建服务时，就有了一些需要额外考虑的点，本文尝试解释各类应用、网站设计者们为了将司空见惯的图片展示在你面前，做了哪些努力，以及为什么要如此设计，或许会让人觉得有趣。

<!--more-->

# 业务设计

## 目的

对于大部分企业来说，图片服务最常用的功能是`缩略`，主要目的是在不过度影响观感的前提下，减少网络传输成本，提升加载速度，节约 CDN 流量费用。

对于 UGC 为主的网站来说，通过一层可控的缩略图服务重新编码，可以限制展示端的图片规格，避免用户上传的超大图片、特殊图片导致展示端卡顿、OOM。以草榴社区为例，其本身不提供图片上传的能力，楼主发图依赖第三方图床，大部分图床没有引导用户使用缩略图功能，导致部分帖子图片体积过大，加载慢、渲染卡，对于以速度为主的主要用户场景，严重影响体验。

另外，与展示端联动的前提下，可以在特定环境下推广更先进的图像格式。以 B 站为例，抓包可以发现，B 站绝大多数图片展示已经使用 WEBP 格式，相比相近观感的 JPEG 图片，体积可以降低三到十倍。

## 要点

### 1. 在线 or 离线

图片处理是一个相对较慢的过程，相比毫秒级的普通 CRUD 接口，对一张图片进行处理，动辄 300~500 毫秒，部分超大图片甚至 30 ~ 60 秒也无法处理完成，因此，将其设计为一个离线服务似乎是最直接的思路。

设计为离线方式，服务需要有能力在图片上传后感知到有哪些可能的展示形式，提前为之生成对应图像并存储，这对于研发团队动辄几千上万人、部门间斗争激烈的中大型互联网公司来说，难度较大。

设计为在线处理，服务必须保证绝大多数请求能够在可接受时间内完成。图片格式繁多，绝大多数企业没有能力自研图片处理基础库，使用第三方基础库往往意味着陷入 CPU 任务后难以跳出，难以调度，基于线程优先级的方案有一定研究价值，但实际使用过程中，想要做到较好的效果，难度较大。

一种比较常见的思路是，部署若干个物理隔离的集群，根据一定的规则分发不同的处理请求到不同集群，避免重型任务与轻量任务相互影响，保证占99%以上的轻量任务能够在较短时间内完成，对于极少数重型任务，可以调高请求超时时间，并在处理完成后主动推送至缓存集群，后续请求超时重试时，会从缓存中极快获取。

### 2. 分隔符 or 请求参数

图片处理服务的调用，主要是为了传递“选择某张图”和“应用在其上的处理操作”两部分信息，一般通过 URL 的修改实现类似功能，但不同的调用形式之间也存在一些细微的区别。常见公有云图片处理服务主要是分隔符和请求参数两类形式，少数公开服务使用多级路径。

以阿里云旧版图片处理服务为例，其设计上使用 `@` 分隔图片地址和处理参数，如:

{{< image src="https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg@300w_300h.webp" caption="https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg@300w_300h.webp" width=300 >}}

其中 `@` 符号前的是[原始图片地址](https://image-demo.img-cn-hangzhou.aliyuncs.com/example.jpg)，其后`300w_300h.webp`为缩略图参数，表示将原图等比例缩放为一个宽不大于300、高不大于300的 webp 图片。

阿里云新版图片处理服务则使用请求参数的形式，如与上面缩略图参数等价的请求：

{{< image src="https://image-demo.oss-cn-hangzhou.aliyuncs.com/example.jpg?x-oss-process=image/resize,w_300/format,webp" caption="https://image-demo.oss-cn-hangzhou.aliyuncs.com/example.jpg?x-oss-process=image/resize,w_300/format,webp" width=300 >}}

这里的缩略参数是`image/resize,w_300/format,webp`。

选择使用请求参数，要注意 CDN 和 内部缓存集群的缓存 Key 配置，要将特定的 Query Parameter Key 作为缓存 Key 的一部分。

选择使用 `@` 符号分隔，意味着原始文件名中的 `@` 符号可能造成一些非预期现象，如 `a.jpg@2x`、`a.jpg@3x` 是常见的设计资源命名形式，对于使用 `@` 符号分隔的服务，则有可能被认为尝试传递一个错误的图片处理参数。

这类场景往往将普通文件访问域名和图片处理域名区分开，如访问 `example.com/a.jpg@100w` 表示访问存储系统中名为 `a.jpg@100w` 的文件，访问`image.example.com/a.jpg@100w` 则表示请求 `example.com/a.jpg` 并进行处理。

由于内部实现细节的影响，部分 CDN 厂商只提供基于 `/` 分隔的前缀删除，这意味着你无法简单清理 `example.com/a.jpg@100w` 和 `example.com/a.jpg@200w` 的缓存。部分 CDN 厂商可能提供基于阉割版正则的批量清理逻辑，可以覆盖这类场景。

### 3. 自由组合 or 可配置模板

在统一图片服务的设计初期，工程师们往往着眼于如何让图片处理更加灵活，更加简单，减少图片服务团队和业务团队之间沟通所需的人力成本，提供大量图片处理参数，可以拼接组合满足大量业务场景需求。

但随着业务的不断演进，需求越来越复杂，演化过程中的 BUG，因为图片服务视角缺乏业务场景信息，任何外在表现的改动都有可能导致特定业务场景受损，需要无限期兼容历史 BUG。

仍然以阿里云图片服务为例，其提供了一种名为[图片样式](https://help.aliyun.com/document_detail/48884.html)的功能，即将一些特定的处理逻辑附加在一个特定的名字上，调用方在 URL 中使用这个名字，就意味着调用这个名字所对应的处理逻辑，而不需要拼接各种参数。

一般要求不同业务场景使用不同样式名，即使图片处理需求相同，也应该使用独立的名字，图片服务团队可以借此感知业务场景，降低管控成本。

### 4. 业务与处理逻辑分离

TODO


### 5. ImageMgaick 的一些坑

TODO